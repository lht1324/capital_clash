# Capital Clash → 온라인 광고판 개발 진행 상황

## 📋 프로젝트 개요
- **기존**: 실제 돈으로 병력을 구매하고 영토를 확장하는 전략 게임
- **새로운 방향**: 투자 지분율에 따라 크기가 달라지는 온라인 광고판 시스템

### 핵심 기능
- 사용자가 투자한 금액에 비례하여 타일 크기 결정
- 타일에 사용자 이미지 표시 (관리자 승인 시스템)
- 타일 클릭 시 사용자 정보 표시
- 투자자별 프로필 정보 관리

### 🚨 중요 제약사항
- **1인당 1개 타일 제한**: 사용자는 하나의 대륙에만 타일을 가질 수 있음
- 복수 타일 소유 불가, 단일 타일 업그레이드 또는 대륙 이전만 가능
- UI는 모두 단일 타일 중심으로 설계됨

## 🛠 기술 스택
- **Frontend**: Next.js 14 (App Router), React Three Fiber, TypeScript, Tailwind CSS
- **상태관리**: Zustand
- **3D 렌더링**: Three.js
- **라이브러리**: maxrects-packer (Treemap 배치)
- **Backend**: Supabase

## ✅ 완료된 단계 (1-16)

### 핵심 구현 사항
1. **투자자 정보 시스템**:
   - 타일 위치, 이미지 상태, 프로필 정보 관리
   - 실시간 위치 정보 업데이트

2. **UI 컴포넌트**:
   - 설정 패널: 투자자 정보, 이미지 업로드, 프로필 관리
   - 프로필 보기: 투자 정보, 통계, 외부 링크
   - Header: 새로운 로고, 로그인/로그아웃, 프로필 드롭다운
   - Sidebar: 3개 탭 (개요/내 영역/통계)

3. **Billboard 배치 알고리즘**:
   - 셀 기반 계산 (50×50 기준)
   - 지분율에 따른 정사방형 크기 결정
   - 행 우선 순회 방식 배치
   - 성능 최적화: 3,000회/초 → 0회/초

4. **관리자 시스템**:
   - 사용자/타일/이미지 관리
   - 실시간 통계 및 모니터링
   - 시스템 설정 및 유지보수

## 🔄 최근 업데이트 및 이슈

### 초기화 및 재구현 시작
**완료 일시**: 2025년 1월 현재 세션

**1. 초기화된 부분**:
- 인증 관련 파일 제거:
  - `src/app/auth/callback/page.tsx`
  - `src/hooks/useAuth.ts`
  - `src/store/userStore.ts`
  - `src/app/RootLayoutClient.tsx`
- UI 컴포넌트 제거:
  - `src/components/ui/button.tsx`
  - `src/components/ui/avatar.tsx`
  - `src/components/ui/dropdown-menu.tsx`
- Three.js 관련:
  - `src/components/ThreeCanvas.tsx`
  - `src/components/ThreeProvider.tsx`
  - `src/contexts/ThreeContext.tsx`

**2. 재구현 완료된 부분**:
- 헤더 UI 재구성:
  - 로고: 왼쪽 배치 (Capital Clash)
  - 주요 버튼: 중앙 배치 (Leaderboard, Purchase Territory)
  - 로그인: 오른쪽 배치 (Google OAuth)
- 모달 시스템:
  - RankingModal: 리더보드 표시
  - PurchaseTileModal: 영역 구매 인터페이스
- 인증 시스템:
  - userStore: 로그인 상태 관리
  - Google OAuth: Supabase 연동
  - 실시간 상태 감지 및 업데이트

**3. 현재 상태**:
- ✅ 헤더 UI 완성
- ✅ 모달 시스템 작동
- ✅ 로그인 시스템 작동 (Google OAuth)
- ✅ 실시간 상태 관리

## 🔄 진행 중인 단계

### 17단계: Supabase 통합 및 실시간 멀티유저 플랫폼 전환
**현재 상태**: 17/20 단계 (85% 완료)

#### ✅ 완료된 부분
1. **Supabase 인프라**:
   - 클라이언트 설정 및 타입 정의
   - 8개 테이블 스키마 구현
   - API 및 커스텀 훅 구현

2. **실시간 멀티유저 시스템**:
   - Supabase 우선 저장 구조
   - 자동 스토어 초기화
   - 실시간 동기화

3. **조회수 시스템**:
   - 세션 기반 중복 방지
   - 실시간 통계 및 순위
   - 관리자 기능 구현

#### 🔄 진행 중: 17-5 완전성 테스트
1. **데이터 연동 테스트**:
   - 작업 중 문제 발생
      - 현재 영역 구매 시 Supabase의 테이블이 업데이트 되지 않는 것을 발견.
      - 추정 원인: 여러 테이블 간 연동으로 인해 파악 중. 현재 대륙 테이블 관련 로직 중 생성 부분 테스트 중.  
   - 사용자 인증 상태 확인
   - 투자자 정보 실시간 업데이트
   - 이미지 업로드 및 상태 관리
   - 조회수 통계 실시간 업데이트

2. **UI 상호작용 테스트**:
   - 사이드바 토글 동작
   - 탭 전환 및 상태 유지
   - 모달 작동 및 폼 제출
   - 실시간 알림 표시

3. **에러 처리 테스트**:
   - 네트워크 오류 처리
   - 잘못된 입력 처리
   - 세션 만료 처리
   - 권한 검증

4. **성능 테스트**:
   - 데이터 로딩 속도
   - 실시간 업데이트 지연
   - 메모리 사용량
   - 렌더링 성능

각 테스트는 실제 사용자 시나리오를 기반으로 진행되며, 발견된 문제는 즉시 수정하고 재테스트를 진행합니다.

5. **테스트 이후 추가 작업 사항**:
   - 프로필의 이미지를 유저의 avatar_url을 src로 해 받아오는 이미지를 띄우는 것으로 변경. avatar_url이 invalid할 경우 기존 이미지를 사용.
   - 영역 구매 모달의 금액 입력란에서 스크롤로 금액을 조절 가능한데 스크롤을 없앨 것. 입력 후 스크롤로 내릴 때 겹쳐서 원치 않게 금액이 내려갈 수 있음.
   - 구글 oAuth로 로그인 후 돌아올 때 로그인 처리 중이라는 로딩 화면을 띄울 것. 지금은 텀이 있어 로그인 상태가 변경되기까지 시간이 걸림.



#### 🔄 진행 필요
1. **사이드바 실제 데이터 연동**
2. **헤더 네비게이션 개선**
3. **완전성 테스트 진행**

## 📋 예정된 단계

### 18단계: UI 데이터 연결 및 실제 인터랙션
1. **영역 구매 시스템 완성**:
   - 기존 구매 모달에 실제 데이터 연동
   - 실시간 지분율 계산 및 표시
   - 결제 시스템 연동 준비 (Lemon Squeezy 플레이스홀더)
   - 구매 완료 프로세스 구현

2. **추가 투자/이전 시스템**:
   - 지분율 증가에 따른 크기 변경
   - 24시간 쿨다운
   - VIP 검증

3. **실시간 알림 시스템**:
   - 투자/VIP/이미지 알림
   - 알림 히스토리
   - 커스텀 UI

### 19단계: 이미지 승인 시스템
1. **관리자 인터페이스**:
   - 승인 대시보드
   - 일괄 처리
   - 자동 필터링

2. **실시간 업데이트**:
   - 승인 상태 반영
   - 렌더링 최적화
   - 히스토리 관리

### 20단계: 결제 시스템
1. **Lemon Squeezy 결제 통합**:
   - 구매 모달과 Lemon Squeezy 연동
   - 결제 프로세스 구현:
     - 구매 버튼 → Lemon Squeezy 결제 → 구매 완료
     - 추가 투자 → Lemon Squeezy 결제 → 투자 완료
   - 결제 상태 실시간 모니터링
   - 실패/취소 시 롤백 처리

2. **결제 관리 시스템**:
   - 결제 내역 대시보드
   - 환불 요청 처리
   - 매출 통계 및 분석
   - 결제 관련 알림 시스템

4. **사용자 경험**:
   - 결제 진행 상태 표시
   - 결제 내역 조회 UI
   - 영수증 및 증빙 자료 제공 (Lemon Squeezy API)
   - 결제 관련 고객 지원 시스템

## 🗂 주요 파일 구조
```
src/
├── lib/
│   ├── treemapAlgorithm.ts    # Billboard 알고리즘
│   ├── supabase.ts            # Supabase 클라이언트
│   └── supabase-api.ts        # API 래퍼
├── store/
│   └── continentStore.ts      # 상태 관리
├── components/
│   ├── ContinentMap.tsx       # 3D 맵
│   ├── TileSettingsPanel.tsx  # 설정 패널
│   ├── ProfileViewModal.tsx   # 프로필 보기
│   ├── Header.tsx             # 헤더
│   └── Sidebar.tsx            # 사이드바
└── app/
    ├── page.tsx               # 메인 페이지
    ├── profile/              # 프로필
    └── admin/                # 관리자
```

## 📞 개발 명령어
```bash
cd /c%3A/Users/Jaeho/Desktop/Projects/Playground/capital_clash_fe
npm run dev
npm run type-check
```
